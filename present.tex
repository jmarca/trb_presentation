\usemodule[simpleslides]
          [style=BigNumber]

\setupTitle
  [ title={Finding Change in the CouchDB},
   author={Dr.~James E. Marca},
     date={January 13, 2013},
  ]

% where are the figures
\setupexternalfigures[directory={./figs/}]
% which figures are being used

% red_couch.png
% sad_dad.png
% cap_theorem.jpg
% data.png
% traffic_circle.png
% girl_bike.png
% driving.png
% couch_girl.png

% Enable hyperlinks
\setupinteraction[state=start, color=middleblue]

\starttext
\placeTitle


% \IncludePicture
% [horizontal]
% [couch_girl.png]
% {Finding Change in the CouchDB}


%%\SlideTitle[big-data]{Big Data}

\IncludePicture
[horizontal]
[data.png]
{Big Data}

\SlideTitle[weve-always-had-big-data]{We've always had big data!}

\startitemize
\item
  We've been handling big data for years in transportation
\item
  What's wrong with sticking to the old tools?
\stopitemize

\SlideTitle[old-way]{Old Way:}

\startitemize
\item
  PostgreSQL
\item
  Simple queries
\item
  Canned aggregates
\stopitemize

\quotation{Is the current reading of volume and occupancy from some
detector more or less than what should be expected?}

\SlideTitle{But we had a new server\ldots{}}

\SlideTitle{\ldots{}and all the raw data
for a year\ldots{}}

\SlideTitle{\ldots{}Ready to query
dynamically\ldots{}}

\SlideTitle[in-postgresql]{\ldots{}In PostgreSQL}

\startblockquote
\quotation{What is the expected volume \crlf
for any 5 minute period \crlf
over the prior 365 days \crlf
for any loop detector}
\stopblockquote

\SlideTitle[my-database-broke]{My database broke}

\IncludePicture
[vertical]
[sad_dad.png]
{\startitemize
\item
  The index was too big to fit in RAM
\item
  Extensive disk swapping
\item
  Super-duper slow!
\stopitemize
}

\SlideTitle[alternatives-for-big-data-nosql]{Grandparents of Big Data
  and NoSQL}

\startitemize
\item
  Google (Big Table)
\item
  Amazon (Dynamo)
\stopitemize


\SlideTitle[options-available-now]{Some options available now}

\startitemize
\item
  Hadoop
\item
  MongoDB
\item
  Riak
\item
  CouchDB
\item
  BigCouch
\item
  Couchbase
\item
  Cassandra
\item
  Voldemort
\item
  RethinkDB
\item
  Datalog
\item
  and more all the time\ldots{}
\stopitemize

%\SlideTitle[why-do-i-think-couchdb-is-good-for-transportation-data]

\IncludePicture
[horizontal]
[red_couch.png]
{CouchDB is great for transportation data}

\SlideTitle[what-is-transportation-data]{What is transportation data?}

\startitemize
\item
  largely observations and measurements
\item
  write once
\item
  read raw data for short term applications
\item
  process raw data into summary stats
\stopitemize

\SlideTitle[example-loop-detectors]{Example: Loop Detectors}

\startitemize
\item
  30s volume, occupancy
\item
  some misses and noise
\item
  run-once cleanup procedures
\stopitemize

\IncludePicture
[horizontal]
[traffic_circle.png]{Even personal travel patterns are repetitive}

% \SlideTitle[example-personal-gps-and-activity-stream]{Example: Personal GPS
% and activity stream}

% \startitemize
% \item
%   second by second GPS
% \item
%   slowly growing sets of:
%   \startitemize
%   \item
%     routes,
%   \item
%     destinations,
%   \item
%     time windows
%   \stopitemize
% \item
%   small set of repeated queries:
%   \startitemize
%   \item
%     Optimize likely activities?
%   \item
%     Does traffic affect my usual pattern?
%   \item
%     etc
%   \stopitemize
% \stopitemize

\SlideTitle[why-do-i-think-couchdb-is-good-for-transportation-data-1]{Why
do I think CouchDB is good for transportation data?}

{\externalfigure[figs/red_couch.png]}\crlf

\IncludePicture
[horizontal]
[red_couch.png]
{What is CouchDB?}

\SlideTitle{CouchDB is a document oriented database}

\startitemize
\item
  no schema
\item
  JSON documents
\item
  Views (map and reduce steps) are analogous to queries
\item
  Eventual consistency
\stopitemize

% \SlideTitle[why-not-just-use-flat-files]{Why not just use flat files?}

% \subsection[consider-loop-detectors]{Consider loop detectors}

% \startitemize
% \item
%   One file per loop detector per year, or
% \item
%   One file for all detectors per day (what PeMS does)
% \item
%   Easy to organize and distribute
% \item
%   Fine for single user
% \stopitemize

% \SlideTitle[but-flat-files-can-lead-to-trouble]{But flat files can lead to
% trouble}

% \startitemize
% \item
%   Bad for multiuser
%   \startitemize
%   \item
%     race conditions,
%   \item
%     version problems,
%   \item
%     etc
%   \stopitemize
% \item
%   Difficult to query
% \stopitemize

% \startblockquote
% \quotation{What was the volume and occupancy like last Monday?}
% \stopblockquote

% \SlideTitle[so-use-a-database]{So use a database}

% {\externalfigure[figs/red_couch.png]}\crlf


\IncludePicture
[horizontal]
[cap_theorem.jpg]{The CAP Theorem}

\SlideTitle[databases-are-limited-by-the-cap-theorem]{Databases are limited
by the CAP theorem}

\startitemize
\item
  {\bf C}onsistency All database clients see the same data, even with
  concurrent updates.
\item
  {\bf A}vailability All database clients are able to access some
  version of the data.
\item
  {\bf P}artition Tolerance The database can be split over multiple
  servers.
\stopitemize

\subsection[choose-any-two]{{\em {\bf Choose any two}}}

\SlideTitle[traditional-rdbms-choose-c-and-a]{Traditional RDBMS choose C
and A}

\SlideTitle[couchdb-chooses-a-and-p]{CouchDB chooses A and P}

\startitemize
\item
  {\bf A}vailability, {\bf P}artition Tolerance
\stopitemize

\startblockquote
\quotation{Eventually Consistent}
\stopblockquote

\SlideTitle[consistency-isnt-that-big-a-deal-for-traffic-data]{Consistency
isn't that big a deal for traffic data}

\startitemize
\item
  This isn't stock trading or e-commerce
\item
  It's okay if:
  \startitemize
  \item
    you are 30s behind reading a loop
  \item
    Controller A has slightly more current info than Controller B
  \stopitemize
\stopitemize

\startblockquote
A universally consistent view isn't mission critical
\stopblockquote

\SlideTitle[bonus-couchdb-has-master-master-replication]{Bonus: CouchDB has
master-master replication}

\SlideTitle[replication-is]{Replication is:}

\SlideTitle[super-awesome]{super awesome}

\SlideTitle[the-change-i-was-looking-for]{the {\em change} I was looking
for}

\SlideTitle[replication-enables-a-new-data-collection-architecture]{Replication
enables a \crlf
new data collection architecture}

\startitemize
\item
  Put the database at the detector (distributed databases)
\item
  Move data around by using replication
\stopitemize

\subsection[uses]{Uses:}

\startitemize
\item
  A TMC can still pull-replicate from all detector databases
\item
  A Local or Freeway specific TMC can limit replication to relevant
  detectors
\item
  A traveler can replicate only the traffic DBs along common routes
\stopitemize

\SlideTitle[all-replicating-databases-will-be-eventually-consistent]{All
replicating databases will be eventually consistent}

\SlideTitle[mastermaster-means-all-are-equally-good-candidates-for-replication]{Master:Master
means all are equally good candidates for replication}

\SlideTitle[relax]{Relax}

\SlideTitle[practical-experience]{Practical experience}

\startitemize[n][stopper=.]
\item
  Processing, storing raw loop detector data
\item
  Imputing missing detector data
\item
  A single stash for storing detector metadata
\stopitemize

\SlideTitle[processing-raw-loop-detector-data]{Processing Raw Loop Detector
Data}

\startitemize
\item
  Orange County, California (CalTrans District 12)
\item
  about 900 mainline detectors
\item
  Process in R
  \startitemize
  \item
    compute 27 different measures per location
  \item
    for 20 minute running time window
  \item
    (vol, occ per lane + 27 ) per 30s period
  \item
    run models estimating relative risk of accident types
  \stopitemize
\item
  280GB of data (three years)
\item
  590GB of generated views
\stopitemize

\SlideTitle[database-design]{Database design:}

\startitemize
\item
  One CouchDB database per detector
\item
  One document per day
\stopitemize

\SlideTitle[document-per-day-reasons]{Document per day reasons:}

\startitemize
\item
  Based on \overstrikes{painful experience} informal testing
\item
  One document per year is too big to process
\item
  One document per timestamp would work okay,
\item
  But the web {\em application} uses daily data
\item
  CouchDB sorts by document id, id is based on timestamp
\item
  HTTP GET:

  /vdsdata/d12/2007/1202248/1202248~2007-01-03~00:00:00
\stopitemize

\SlideTitle[database-per-detector-per-year-reasons]{Database per detector
per year reasons:}

\startitemize
\item
  One big database is possible, but
\item
  Impossible to {\em split} or {\em shard} over different machines (now
  can use BigCouch)
\item
  makes better use of multi-core machines when generating views
\stopitemize

\SlideTitle[use-views-to-run-models-and-summarize-data]{Use views to run
models and summarize data}

\startitemize
\item
  Views are CouchDB's version of map/reduce
\item
  Write JavaScript code for the map function that is run on each
  document (to apply models, run summaries, etc)
\item
  ProTip\high{Â©} Only use embedded Erlang reduce functions like
  \type{_count},\type{_sum}, and \type{_stats}
\stopitemize

\SlideTitle[difficulty-need-to-use-another-database-to-collate-model-output]{Difficulty:
Need to use another database to collate model output}

\startitemize
\item
  Pipe summaries of the per-detector views to a single database for all
  detectors in the district
\item
  Requires external programming
\item
  Difficult to automate
\stopitemize

\SlideTitle[application-2-storing-the-results-of-imputation-runs]{Application
2: Storing the results of imputation runs}

\startitemize
\item
  Similar to prior example
\item
  400GB of data
\item
  700GB of generated views
\item
  Databases spread over three machines
\item
  Uses per-district collation databases
\item
  Analysis step used CouchDB to coordinate multiple processes
  \startitemize
  \item
    Local \quotation{state} database on each machine
  \item
    State databases replicated with each other
  \item
    No overlapping runs were observed
  \stopitemize
\stopitemize

\SlideTitle[application-3-convenient-stash-for-detector-metadata]{Application
3: Convenient stash for detector metadata}

\startitemize
\item
  20GB of data
\item
  222MB of generated views
\item
  Uses GeoCouch extensions, stores location of each detector
\item
  Stashes all known metadata about each detector in a single place
\item
  Uses binary attachments to save R analysis output (plots, files)
\item
  Small enough to replicate to my laptop too
\stopitemize

\SlideTitle[questions]{Questions?}

\subsection[james-e.-marca-uci-its-jmarcatranslab.its.uci.edu]{James E.
Marca \crlf
UCI ITS \crlf
jmarca@translab.its.uci.edu}

\stoptext
